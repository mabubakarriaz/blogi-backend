# Docker
# Build a Docker image
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
- main

resources:
- repo: self

variables:
  tag: 'latest' # '$(Build.BuildId)'

stages:
- stage: Build
  displayName: Build image
  jobs:
  - job: Build
    displayName: Build
    pool:
      name: Default
      # vmImage: ubuntu-latest
    steps:

    - task: DockerInstaller@0
      inputs:
        dockerVersion: '17.09.0-ce'

    - task: Docker@2
      displayName: Build an image
      inputs:
        containerRegistry: 'docker-registry'
        repository: 'abubakarriaz/blogi-backend'
        command: buildAndPush
        dockerfile: '$(Build.SourcesDirectory)/src/Dockerfile'
        tags: $(tag)
    
    #- task: AzureRmWebAppDeployment@4
    #  inputs:
    #    ConnectionType: 'AzureRM'
    #    azureSubscription: 'rm-managed-id'
    #    appType: 'webAppContainer'
    #    WebAppName: 'blogibackend22448822'
    #    DockerNamespace: 'docker.io'
    #    DockerRepository: 'abubakarriaz/blogi-backend'
    #    DockerImageTag: 'latest'    
    - task: AzureWebAppContainer@1
      inputs:
        azureSubscription: 'rm-managed-id'
        appName: 'blogibackend22448822'
        containers: 'docker.io/abubakarriaz/blogi-backend:latest'